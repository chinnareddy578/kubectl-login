# Local OIDC Testing with Docker

This guide explains how to set up and test kubectl-login with a self-hosted OIDC server (Keycloak) running in Docker.

## Quick Start

```bash
# 1. Start Keycloak
docker-compose up -d

# 2. Wait for Keycloak to be ready (about 30 seconds)
docker-compose logs -f keycloak

# 3. Setup Keycloak (create realm, client, user)
./scripts/setup-keycloak.sh

# 4. Test authentication
./scripts/test-with-keycloak.sh
```

## Prerequisites

- Docker and Docker Compose installed
- `curl` and `jq` (optional, for JSON parsing)
- kubectl-login built (`make build`)

## Step-by-Step Setup

### 1. Start Keycloak

```bash
# Start Keycloak and PostgreSQL
docker-compose up -d

# Check logs
docker-compose logs -f keycloak

# Wait for "Keycloak is ready" message
```

Keycloak will be available at: http://localhost:8080

### 2. Configure Keycloak

Run the setup script to create:
- A realm for testing
- A client for kubectl-login
- A test user

```bash
chmod +x scripts/setup-keycloak.sh
./scripts/setup-keycloak.sh
```

The script will output:
- Issuer URL
- Client ID
- Client Secret
- Test user credentials

**Save the client secret!** You'll need it for testing.

### 3. Create Config File

Create `~/.kubectl-login/config.json` with the values from setup:

```json
{
  "issuer_url": "http://localhost:8080/realms/kubectl-login",
  "client_id": "kubectl-login-client",
  "client_secret": "your-client-secret-here",
  "headless": false,
  "port": 8000
}
```

### 4. Test Authentication

#### Browser Mode (Interactive)

```bash
# Using config file
./kubectl-login --config ~/.kubectl-login/config.json

# Or with command-line flags
./kubectl-login \
  --issuer-url http://localhost:8080/realms/kubectl-login \
  --client-id kubectl-login-client \
  --client-secret your-client-secret
```

This will:
1. Open your browser to Keycloak login page
2. Log in with test user (testuser / testpassword)
3. Redirect back and authenticate
4. Cache the token

#### Using Test Script

```bash
chmod +x scripts/test-with-keycloak.sh
./scripts/test-with-keycloak.sh auth
```

### 5. Test Exec Credential Plugin

Test the kubectl exec credential plugin interface:

```bash
# Using test script
./scripts/test-with-keycloak.sh exec

# Or manually
echo '{"apiVersion":"client.authentication.k8s.io/v1beta1","kind":"ExecCredential"}' | \
  ./kubectl-login \
    --issuer-url http://localhost:8080/realms/kubectl-login \
    --client-id kubectl-login-client \
    --client-secret your-client-secret
```

## Keycloak Admin Console

Access the Keycloak Admin Console:

- URL: http://localhost:8080
- Username: `admin`
- Password: `admin`

You can:
- View and modify the realm
- Manage clients
- Manage users
- View authentication flows

## Test User

Default test user created by setup script:

- **Username**: `testuser`
- **Password**: `testpassword`
- **Email**: `testuser@example.com`

## Configuration Details

### Realm
- **Name**: `kubectl-login`
- **URL**: `http://localhost:8080/realms/kubectl-login`

### Client
- **Client ID**: `kubectl-login-client`
- **Client Secret**: Generated by setup script
- **Redirect URI**: `http://localhost:8000/callback`
- **Flow**: Authorization Code Flow

### Scopes
- `openid` (required)
- `profile`
- `email`
- `offline_access` (for refresh tokens)

## Troubleshooting

### Keycloak Not Starting

```bash
# Check logs
docker-compose logs keycloak

# Restart
docker-compose restart keycloak

# Check health
curl http://localhost:8080/health/ready
```

### Setup Script Fails

```bash
# Check if Keycloak is ready
curl http://localhost:8080/health/ready

# Wait a bit longer if needed
sleep 10
./scripts/setup-keycloak.sh
```

### Authentication Fails

1. **Check redirect URI**: Must be `http://localhost:8000/callback`
2. **Check client secret**: Verify it matches the one in Keycloak
3. **Check port**: Make sure port 8000 is available
4. **Check browser**: Browser should open to Keycloak login

### Port Already in Use

If port 8000 is in use:

```bash
# Use different port
./kubectl-login --port 8001 --issuer-url ... --client-id ...
```

Update redirect URI in Keycloak client settings to match.

## Advanced Usage

### Multiple Realms

Create additional realms for different test scenarios:

1. Access Keycloak Admin Console
2. Create new realm
3. Create client in new realm
4. Use different issuer URL

### Custom Users

Add users via Admin Console or API:

```bash
# Get admin token
TOKEN=$(curl -s -X POST "http://localhost:8080/realms/master/protocol/openid-connect/token" \
  -d "username=admin" \
  -d "password=admin" \
  -d "grant_type=password" \
  -d "client_id=admin-cli" | jq -r '.access_token')

# Create user
curl -X POST "http://localhost:8080/admin/realms/kubectl-login/users" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "newuser",
    "enabled": true,
    "credentials": [{
      "type": "password",
      "value": "password123",
      "temporary": false
    }]
  }'
```

### Headless Mode Testing

For CI/CD testing, you can test headless mode:

```bash
# Note: Keycloak device flow requires additional configuration
# For now, use client credentials flow
./kubectl-login \
  --issuer-url http://localhost:8080/realms/kubectl-login \
  --client-id kubectl-login-client \
  --client-secret your-client-secret \
  --headless
```

## Cleanup

```bash
# Stop containers
docker-compose down

# Remove volumes (deletes all data)
docker-compose down -v

# Remove images
docker-compose down --rmi all
```

## Integration with kubectl

Once authenticated, configure kubectl to use the plugin:

```yaml
# ~/.kube/config
apiVersion: v1
kind: Config
users:
- name: keycloak-user
  user:
    exec:
      apiVersion: client.authentication.k8s.io/v1beta1
      command: kubectl-login
      args:
      - --issuer-url
      - http://localhost:8080/realms/kubectl-login
      - --client-id
      - kubectl-login-client
      - --client-secret
      - your-client-secret
```

## Security Notes

⚠️ **Important**: This setup is for **testing only**!

- Default admin credentials are insecure
- HTTP (not HTTPS) is used
- No production security measures
- Do NOT use in production environments

For production:
- Use HTTPS
- Change default passwords
- Enable proper security settings
- Use proper database
- Configure proper networking

## Next Steps

1. ✅ Test browser authentication
2. ✅ Test exec credential plugin
3. ✅ Test token refresh
4. ✅ Test with kubectl
5. ✅ Test headless mode (if needed)

## Resources

- [Keycloak Documentation](https://www.keycloak.org/documentation)
- [OIDC Specification](https://openid.net/specs/openid-connect-core-1_0.html)
- [Docker Compose Documentation](https://docs.docker.com/compose/)


